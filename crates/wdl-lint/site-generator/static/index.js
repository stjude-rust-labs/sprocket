import state from "./default-state.json"; // Generated by `cargo generate-lint-site`
import Alpine from 'alpinejs';
import persist from '@alpinejs/persist';
import * as common from '../../../../web-common/dist/common.js';
import toml from '@shikijs/langs/toml';

Alpine.plugin(persist)

const urlParams = new URLSearchParams(window.location.search);

Alpine.data('App', () => ({
    tab: urlParams.get('tab') || state.defaultTab,
    search: Alpine.$persist('').using(sessionStorage),
    wdlLint: {
        activeTags: state.defaultTags,
        allLints: state.wdlLint.allLints,
        version: state.wdlLint.currentVersion,
    },
    wdlAnalysis: {
        allLints: state.wdlAnalysis.allLints,
        version: state.wdlAnalysis.currentVersion,
    },

    switchTab(tab) {
        this.tab = tab;

        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);

        params.set('tab', tab);
        url.search = params.toString();
        window.history.pushState({}, '', url);
    },

    focusSearch(event) {
        if (['INPUT', 'TEXTAREA'].includes(event.target.tagName)) return;

        event.preventDefault();
        this.$refs.searchBox.focus();
    },

    toggleTag(tag) {
        if (this.wdlLint.activeTags.includes(tag)) {
            this.wdlLint.activeTags = this.wdlLint.activeTags.filter(t => t !== tag);
        } else {
            this.wdlLint.activeTags.push(tag);
        }
    },

    isVisible(lint) {
        const tagMatch = lint.tags.length === 0 ||
            this.wdlLint.activeTags.some(tag => lint.tags.includes(tag));
        if (!tagMatch) return false;

        const lintSource = this[lint.source];

        if (!this.search) return true;
        const query = this.search.toLowerCase();

        if (lint.id.toLowerCase().includes(query)) return true;

        const lintDocs = (lint.docs || "").toLowerCase();
        return query.split(" ").every(term => lintDocs.includes(term));
    }
}));

Alpine.start();

// TOML highlighting is used in config examples
await common.initManualHighlighting([toml]);